<%- include('partials/header') %>

<section class="page-header">
  <div class="container">
    <h1><i class="bi bi-lock me-2"></i>Checkout</h1>
  </div>
</section>

<section class="section-padding">
  <div class="container">
    <div class="row g-4">
      <div class="col-lg-7">
        <div class="checkout-card">
          <h4><i class="bi bi-geo-alt me-2"></i>Shipping Address</h4>
          <form id="checkoutForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Full Name *</label>
                <input type="text" name="fullname" id="fullname" class="form-control" 
                       value="<%= currentUser.fullname %>" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone *</label>
                <input type="tel" name="phone" id="phone" class="form-control" 
                       value="<%= currentUser.phone || '' %>" required>
              </div>
              <div class="col-12">
                <label class="form-label">Street Address *</label>
                <input type="text" name="street" id="street" class="form-control" 
                       value="<%= currentUser.address ? currentUser.address.street || '' : '' %>" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">City *</label>
                <input type="text" name="city" id="city" class="form-control" 
                       value="<%= currentUser.address ? currentUser.address.city || '' : '' %>" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">State *</label>
                <input type="text" name="state" id="state" class="form-control" 
                       value="<%= currentUser.address ? currentUser.address.state || '' : '' %>" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Pincode *</label>
                <input type="text" name="pincode" id="pincode" class="form-control" 
                       value="<%= currentUser.address ? currentUser.address.pincode || '' : '' %>" required>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="cart-summary checkout-summary">
          <h4>Order Summary</h4>
          <div class="checkout-items">
            <% cart.forEach(item => { %>
              <div class="checkout-item">
                <div class="checkout-item-img">
                  <% if (item.product.images && item.product.images.length > 0) { %>
                    <img src="<%= item.product.images[0] %>" alt="">
                  <% } %>
                  <span class="checkout-qty-badge"><%= item.quantity %></span>
                </div>
                <div class="checkout-item-info">
                  <span class="checkout-item-name"><%= item.product.name %></span>
                  <% const price = item.product.discountPrice && item.product.discountPrice < item.product.price ? item.product.discountPrice : item.product.price; %>
                  <span class="checkout-item-price">&#8377;<%= (price * item.quantity).toLocaleString('en-IN') %></span>
                </div>
              </div>
            <% }) %>
          </div>
          <hr>
          <div class="summary-row">
            <span>Subtotal</span>
            <span>&#8377;<%= cartTotal.toLocaleString('en-IN') %></span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span class="text-success">Free</span>
          </div>
          <hr>
          <div class="summary-row summary-total">
            <strong>Total</strong>
            <strong>&#8377;<%= cartTotal.toLocaleString('en-IN') %></strong>
          </div>
          <button type="button" id="payBtn" class="btn btn-primary btn-lg w-100 mt-3">
            <i class="bi bi-credit-card me-2"></i>Pay &#8377;<%= cartTotal.toLocaleString('en-IN') %>
          </button>
          <div class="text-center mt-3">
            <small class="text-muted"><i class="bi bi-shield-check me-1"></i>Secured by Razorpay</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.getElementById('payBtn').addEventListener('click', async function () {
    const form = document.getElementById('checkoutForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    try {
      const response = await fetch('/payment/create-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          fullname: document.getElementById('fullname').value,
          phone: document.getElementById('phone').value,
          street: document.getElementById('street').value,
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          pincode: document.getElementById('pincode').value
        })
      });

      const data = await response.json();
      if (data.error) {
        alert(data.error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-credit-card me-2"></i>Pay ₹<%= cartTotal.toLocaleString("en-IN") %>';
        return;
      }

      const options = {
        key: data.keyId,
        amount: data.amount,
        currency: data.currency,
        name: 'Garud Classes',
        description: 'Educational Products Purchase',
        order_id: data.razorpayOrderId,
        handler: async function (response) {
          try {
            const verifyRes = await fetch('/payment/verify-payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                order_id: data.orderId
              })
            });
            const result = await verifyRes.json();
            if (result.success) {
              window.location.href = '/payment/order-success/' + result.orderId;
            } else {
              alert('Payment verification failed. Please contact support.');
            }
          } catch (err) {
            alert('Payment verification error. Please contact support.');
          }
        },
        prefill: {
          name: document.getElementById('fullname').value,
          contact: document.getElementById('phone').value,
          email: '<%= currentUser.email %>'
        },
        theme: {
          color: '#2563eb'
        },
        modal: {
          ondismiss: function () {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-credit-card me-2"></i>Pay ₹<%= cartTotal.toLocaleString("en-IN") %>';
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    } catch (err) {
      alert('Something went wrong. Please try again.');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-credit-card me-2"></i>Pay ₹<%= cartTotal.toLocaleString("en-IN") %>';
    }
  });
</script>

<%- include('partials/footer') %>
